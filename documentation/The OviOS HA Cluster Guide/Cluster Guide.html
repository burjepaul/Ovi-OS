<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@500&family=Poppins&display=swap"
      rel="stylesheet"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>

    <title>OviOS Linux</title>
    <link rel="icon" type="image/png" href="/Images/Favicon.jpg" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="download-body-tag">
      <!-- Nav Bar -->
      <section class="navigation-section" id="nav-Section">
        <nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark py-0">
          <a href="">
            <img
              class="navbar-logo"
              src="/Images/LogoImage.png"
              style="margin-left: 15%"
              alt=""
            />
          </a>
          <a class="navbar-brand" style="margin-left: 1%" href=""
            >Ovi OS Linux</a
          >
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarTogglerDemo01"
            aria-controls="navbarTogglerDemo01"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarTogglerDemo01">
            <ul class="navbar-nav ms-auto">
              <li class="navbar-item">
                <a href="../../index.html" class="nav-link">Home</a>
              </li>
              <li class="navbar-item">
                <a href="../../nav-content/download/download.html" class="nav-link">Download</a>
              </li>
              <li class="navbar-item">
                <div class="dropdown">
                  <button
                    class="btn btn-dark dropdown-toggle"
                    type="button"
                    id="dropdownMenuButton2"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    Documentation
                  </button>
                  <ul
                    class="dropdown-menu dropdown-menu-dark"
                    aria-labelledby="dropdownMenuButton2"
                  >
                    <li>
                      <li>
                        <a
                          class="dropdown-item"
                          href="../Documentation/documentation.html"
                          >Documentation</a
                        >
                      </li>
                      <a
                        class="dropdown-item"
                        href="../The admin guide/adminguide.html"
                        >The Admin Guide</a
                      >
                    </li>
                    <li>
                      <a
                        class="dropdown-item"
                        href="../System backup and system live guide/system_backup.html"
                        >System backup and system live guide</a
                      >
                    </li>
                    <li>
                      <a
                        class="dropdown-item"
                        href="../The autosnap Guide/autosnap.html"
                        >The 'autosnap' Guide</a
                      >
                    </li>
                    <li>
                      <a
                        class="dropdown-item"
                        href="../The 'bondadm' Guide/bondadm.html"
                        >The 'bondadm' Guide</a
                      >
                    </li>
                    <li>
                      <a
                        class="dropdown-item"
                        href="../The 'options Guide/options.html"
                        >The 'options' Guide</a
                      >
                    </li>
                    <li>
                      <a
                        class="dropdown-item"
                        href=""
                        >The OviOS HA Cluster Guide</a
                      >
                    </li>
                  </ul>
                </div>
              </li>
              <li class="navbar-item">
                <a class="nav-link" href="../../nav-content/use-cases/use-cases.html"
                  >Use Cases</a
                >
              </li>
              <li class="navbar-item">
                <a class="nav-link" href="../../nav-content/FAQ/FAQ.html">FAQ & Features</a>
              </li>
              <li class="navbar-item">
                <a class="nav-link" href="../../nav-content/contact/contact.html">Contact</a>
              </li>
              <li class="navbar-item">
                <a class="nav-link" href="../../nav-content/Services/services.html"
                  >Services</a
                >
              </li>
            </ul>
          </div>
        </nav>
      </section>

      <!-- Title section -->
      <div class="title">
        <h1>The OviOS HA Cluster Guide</h1>
      </div>

      <div class="plain-text">
       <p><strong>OviOS Linux in a HA Cluster setup.</strong></p>
       <p>The recommended set up is a 3-node cluster with OviOS Linux for automatic failover.</p>
       <p>A 2-node cluster setup is possible, but this won't allow for automatic failover. In a 2 node HA Cluster setup the storage Admin has to manualkly failover the resources (Pools and  virtual IP)  if the main node experiences downtime.</p>
       <p>The following is the cluster setup that has been tested with OviOS to achieve the best results.</p>
       <p>This use case consists of 3 OviOS Linux nodes with shared storage.</p>
       <p><strong>Requirements:</strong></p>
       <p><strong>1. Three OviOS Linux nodes with shares storage.</strong></p>
       <p><strong>&nbsp &nbsp &nbsp &nbspThis means all nodes in the cluster must use the same RAID controller, JBODs , drives etc.</strong></p>
       <p>&nbsp &nbsp &nbsp &nbspA 2 node setup has also been tested with the same configuration. The difference is a 2-node cluster doesn't do automatic failover.</p> <br>
       <p><strong>2. One Resource Group containing the ZFS resource for storage pools, the virtual IP plugin and the SCSI-3 fence agent.</strong></p> <br>
       <p><strong>3. The following options set in on ALL nodes:</strong></p>
       <p>Run the following command on all nodes in the cluster. This will automatically enable other required options for the cluster.</p>
       <p class="old-type">ovios-shell&gt; options cluster.enable 1 <br>
        Changing option: cluster.enable ==&gt; on <br>
        Changing option: autosync.cluster ==&gt; on if not on already <br>
        Changing option: autosync.cluster ==&gt; on <br>
        Changing option: skip.import ==&gt; on if not on already <br>
        Option skip.import is already on <br>
        ovios-shell&gt;</p> <br>
        <p><strong>4. The /etc/hosts files must be configured to contain each node's IP , hostname and FQDN</strong></p>
        <p>Ex:</p>
        <p class="old-type">
          192.168.86.101  cluster1 <br>
192.168.86.102  cluster2 <br>
192.168.86.103  cluster3 <br> <br>
 
172.21.11.101 cluster1.localdomain <br>
172.21.11.102 cluster2.localdomain <br>
172.21.11.103 cluster3.localdomain <br>
        </p> <br>
        <p><strong>5. Passwordless authentication between ALL nodes in the cluster must be configured (for auto-sync)</strong></p>
        <p>Run the following command on all nodes in the cluster to allow SSH connections with root.</p>
        <p class="old-type">ovios-shell&gt; options ssh.allow.root 1
          Changing option: ssh.allow.root ==&gt; on
          ovios-shell&gt;</p> <br>
          <p>Run : <strong>ssh-keygen</strong> on all nodes to generate public and private keys.</p>
          <p>Run: ssh-copy-id -i ~/.ssh/id_rsa.pub &lt;<strong>hostname of the remote server</strong>&gt; to complete passwordless authentication. </p>
          <p>Do this for all nodes in the cluster.</p>
          <br>
          <p><strong>6. On each node configure a bonded interface with the SAME name for the VIP.</strong></p>
          <p>EX: do this on ALL nodes in the cluster!</p>
          <p class="old-type">
            ovios-indt:~ # bondadm -n ovios-ha -i eth1 -i eth2 -m 0 <br>
            &nbsp &nbsp*&nbsp &nbsp  Adding eth1 as slave...  &nbsp &nbsp &nbsp &nbsp  [  OK  ] <br>
            &nbsp &nbsp*&nbsp &nbsp  Adding eth2 as slave...  &nbsp &nbsp &nbsp &nbsp  [  OK  ] <br>
     Finished setting up ovios-ha <br>
     Run : netsetup : to set up the IPs. <br>
ovios-indt:~ #
          </p> <br>
          <p>This creates an interface named ovios-ha.</p>
          <p><strong>SETUP the cluster.</strong></p>
          <p><strong>Run the following commands on ALL nodes  in the cluster:</strong></p>
          <p><strong>&nbsp &nbsp &nbsp &nbspThis commands are run on the linux shell:</strong></p>
          <p class="old-type"># pcs cluster setup --local --name ovios-cluster cluster1,cluster1.localdomain cluster2,cluster2.localdomain cluster3,cluster3.localdomain</p>
          <p>The following errors can be ignored:</p>
          <p class="old-type">
            Shutting down pacemaker/corosync services... <br>
sh: service: command not found <br>
sh: service: command not found <br>
sh: service: command not found <br>
Killing any remaining services... <br>
Removing all cluster configuration files... <br>
          </p> <br>
          <p><strong>Do not use "pcs cluster start"</strong>as pcs looks for a "service" command to start corosync and pacemaker.</p>
          <p>OviOS Linux uses it's own implementation of the services commands.</p>
          <p><strong>Run "cluster start" on ALL nodes to start the cluster.</strong></p>
          <p>Verify the cluster status: "crm_mon -1"</p>
          <p>When the cluster is up and running , on <strong>ONLY ONE node</strong>run the following commands to setup the Resource Group:</p>
          <p class="old-type"># pcs resource create STORAGE lsb:zfs-hac is-managed=true op monitor interval=10s meta resource-stickiness=100</p> <br>
          <p>This creates the resource called "STORAGE" which is managed by the zfs-hac script.</p>
          <p class="old-type"># pcs resource create VIP ocf:heartbeat:IPaddr2 ip=172.21.11.104 cidr_netmask=24 nic=ovios-ha op monitor interval=15s meta resource-stickiness=100</p>
          <p>This creates a VIP assigned to eth0. The Storage services will be available via this IP and will be migrated between nodes during failover.</p> <br>
          <p class="old-type">
            # pcs stonith create SCSI-RES fence_scsi devices="/dev/disk/by-path/disk1,/dev/disk/ <br> by-path/disk2" pcmk_host_list="cluster1 cluster2 cluster3" \ <br>
pcmk_host_map="cluster1=cluster1.localdomain;cluster2= cluster2.localdomain;cluster3=cluster3. <br> localdomain" meta provides=unfencing resource-stickiness=100 power_wait=3 op monitor interval=20s <br>
          </p> <br>
          <p>This creates a SCSI-3 reservation fence-agent to provide protection against data corruption.</p>
          <p>At this point the HA-Cluster is up and running.</p>
          <p>Should a node import the storage pools while they already are active on another node, it will receive a reservation conflict and panic.</p>
          <p>The<strong> devices=" "</strong>must contain the drives used by the storage Pools. It must contain at least one drive from each pool (if multiple pools have been created)</p>
          <p class="old-type">pcs resource group add RG SCSI-RES STORAGE VIP</p> <br>
          <p>This creates a resource group containing all resources.</p>
          <p>The Resource Group will now start on one node in the cluster.</p>
          <p>Make sure to set:</p>
          <p class="old-type">
            pcs property set stonith-enabled=true
          </p> <br>
          <p>The following option must be set to "stop" on a 3-node cluster or "ignore" on a 2-node cluster</p> <br>
          <p><strong>3-node cluster:</strong></p>
          <p class="old-type">pcs property set no-quorum-policy=stop</p> <br>
          <p><strong>2-node cluster:</strong></p>
          <p class="old-type">pcs property set no-quorum-policy=ignore </p> <br>
      </div>

  </div>

  <footer>
    <div class="row div-container">
      <div class="col-md-3 div-footer sign">
        <a href="">
          <img
            src="/Images/Favicon copy.png"
            width="130px"
            style="margin-left: 15%"
            alt=""
          />
          <a class="navbar-brand footer-text-logo" href="">Ovi OS Linux</a>
        </a>
      </div>
      <div class="col-md-3 div-footer">
        <h5>Documentation</h5>
        <br />
        <a href="../The admin guide/adminguide.html"
          >The Admin Guide</a
        >
        <br />
        <a
          href="../System backup and system live guide/system_backup.html"
          >System backup and system live guide</a
        >
        <br />
        <a href="../The autosnap Guide/autosnap.html"
          >The 'autosnap' Guide</a
        >
        <br />
        <a href="../The 'bondadm' Guide/bondadm.html"
          >The 'bondadm' Guide</a
        >
        <br />
        <a href="../The 'options Guide/options.html"
          >The 'options' Guide</a
        >
        <br />
        <a
          href="../The OviOS HA Cluster Guide/Cluster Guide.html"
          >The OviOS HA Cluster Guide</a
        >
        <br /><br /><br />
      </div>
      <div class="col-md-3 div-footer">
        <h5>Technology</h5>
        <br />
        <a href="../../nav-content/download/download.html">Download</a>
        <br />
        <a href="../../nav-content/use-cases/use-cases.html">Use Cases</a>
        <br />
        <a href="../../nav-content/FAQ/FAQ.html">FAQ & Features</a>
        <br />
        <a href="../../nav-content/Services/services.html">Services</a>
        <br /><br /><br />
      </div>
      <div class="col-md-3 div-footer">
        <h5>Contact</h5>
        <br />
        <a href="../../nav-content/contact/contact.html">ovi@ovios.org</a>
      </div>
    </div>
    <div class="social-media-logos">
      <a href="https://twitter.com/ovioslinux" target="_blank">
        <i class="fa-brands fa-twitter"></i
      ></a>
      <a
        href="https://www.youtube.com/c/oviosorgstorage/videos"
        target="_blank"
        ><i class="fa-brands fa-youtube"></i
      ></a>
      <p class="copyright-text">Copyright © 2012-2022 OviOS Linux</p>
    </div>
  </footer>
    
    <!-- Script -->
    <script src="script.js"></script>
  </body>
</html>
